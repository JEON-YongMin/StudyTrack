<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Study Track - Notice Detail</title>
    <meta charset="UTF-8">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light">

<!-- TOP BAR -->
<nav class="navbar navbar-light bg-white shadow-sm">
    <div class="container">
        <a href="/" class="navbar-brand fw-bold text-primary">ğŸ“– Study Track</a>
        <div id="navAuthArea" class="d-flex gap-2 align-items-center"></div>
    </div>
</nav>

<div class="container py-4">

    <!-- BREADCRUMB / HEADER -->
    <div class="mb-3">
        <div class="text-muted small">
            <a th:href="@{/study/{id}(id=${study.id})}" class="text-decoration-none">ìŠ¤í„°ë””</a>
            <span class="mx-1">/</span>
            <a th:href="@{/study/{id}/notice(id=${study.id})}" class="text-decoration-none">ê³µì§€ì‚¬í•­</a>
            <span class="mx-1">/</span>
            <span>ìƒì„¸</span>
        </div>
    </div>

    <div class="row">

        <!-- MAIN -->
        <div class="col-md-8">

            <!-- NOTICE CARD -->
            <div class="bg-white p-4 rounded shadow-sm mb-4"
                 th:with="m=${mode}">

                <form id="noticeForm" name="noticeForm">

                    <input type="hidden" id="studyId" th:value="${study.id}">
                    <input type="hidden" id="noticeId" th:value="${notice != null ? notice.id : ''}">
                    <input type="hidden" id="mode" th:value="${mode}">

                    <!-- editì¼ ë•Œ PUT ì²˜ë¦¬ -->
                    <input type="hidden" name="_method" value="put" th:if="${m == 'edit'}"/>

                    <div class="d-flex justify-content-between align-items-start">
                        <div>

                <span class="badge bg-primary mb-2"
                      th:text="${study.category}">CS</span>

                            <!-- ì œëª© -->
                            <div th:if="${m == 'view'}">
                                <h3 class="fw-bold mb-2"
                                    th:text="${notice.title}">ê³µì§€ ì œëª©</h3>
                            </div>

                            <div th:if="${m != 'view'}">
                                <input type="text"
                                       name="title"
                                       class="form-control mb-2"
                                       th:value="${notice != null ? notice.title : ''}"
                                       placeholder="ê³µì§€ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”"/>
                            </div>

                            <!-- ë©”íƒ€ì •ë³´ (viewì—ì„œë§Œ) -->
                            <div class="text-muted small"
                                 th:if="${m == 'view'}">
                                <span>ì‘ì„±ì: </span>
                                <span class="fw-semibold"
                                      th:text="${author.nickname}">í™ê¸¸ë™</span>
                                <span class="mx-2">â€¢</span>
                                <span th:text="${notice.createdAt}">2026-02-20</span>
                            </div>
                        </div>

                    </div>

                    <hr class="my-4">

                    <!-- ë‚´ìš© -->
                    <div th:if="${m == 'view'}"
                         class="lh-lg"
                         style="white-space: pre-wrap;"
                         th:text="${notice.content}">
                    </div>

                    <div th:if="${m != 'view'}">
                        <textarea name="content" class="form-control" rows="8" th:text="${notice != null ? notice.content : ''}" placeholder="ê³µì§€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”">

                        </textarea>
                    </div>

                    <div class="d-flex justify-content-end mt-4"
                         th:with="m=${mode}">

                        <!-- create -->
                        <button type="submit"
                                class="btn btn-primary"
                                th:if="${m == 'create'}">
                            ë“±ë¡
                        </button>

                        <!-- edit -->
                        <div th:if="${m == 'edit'}" class="d-flex gap-2"> <button type="submit" class="btn btn-primary">
                                ì €ì¥
                            </button>
                            <a class="btn btn-outline-secondary" th:href="@{/study/{studyId}/notice/{noticeId}(studyId=${study.id}, noticeId=${notice.id}, mode='view')}">
                                ì·¨ì†Œ
                            </a>
                        </div>

                        <!-- view + ê¶Œí•œ -->
                        <div th:if="${m == 'view'}" class="d-flex gap-2">
                            <button type="button" id="editBtn" class="btn btn-outline-secondary">
                                ìˆ˜ì •
                            </button>

                            <button type="button" id="deleteBtn" class="btn btn-outline-danger">
                                ì‚­ì œ
                            </button>
                        </div>
                    </div>
                </form>
            </div>

            <!-- BACK -->
            <div class="d-flex justify-content-between">

                <a th:href="@{/study/{id}(id=${study.id})}" class="btn btn-outline-primary">
                    ìŠ¤í„°ë”” í™ˆ
                </a>
            </div>

        </div>

        <!-- SIDE -->
        <div class="col-md-4">

            <!-- STUDY SUMMARY -->
            <div class="bg-white p-4 rounded shadow-sm mb-3">
                <h6 class="fw-bold mb-2">ğŸ“Œ ìŠ¤í„°ë”” ì •ë³´</h6>
                <div class="small">
                    <div class="mb-1">
                        <span class="text-muted">ìŠ¤í„°ë””ëª…</span><br>
                        <span class="fw-semibold" th:text="${study.title}">ì•Œê³ ë¦¬ì¦˜ ìŠ¤í„°ë””</span>
                    </div>
                    <div class="mb-1">
                        <span class="text-muted">ë©¤ë²„</span><br>
                        ğŸ‘¥ <span th:text="${study.memberCount}">5</span>ëª…
                    </div>
                    <div>
                        <span class="text-muted">ìš´ì˜ì</span><br>
                        <span th:text="${ownerName}">í™ê¸¸ë™</span>
                    </div>
                </div>
            </div>

            <!-- QUICK ACTIONS -->
            <div class="bg-white p-4 rounded shadow-sm mb-3">
                <h6 class="fw-bold mb-2">âš¡ ë¹ ë¥¸ ì‘ì—…</h6>

                <a th:href="@{/notice/create?studyId={id}(id=${study.id})}"
                   class="btn btn-primary btn-sm w-100 mb-2">
                    ê³µì§€ ì‘ì„±
                </a>

                <a th:href="@{/assignment/create?studyId={id}(id=${study.id})}"
                   class="btn btn-outline-primary btn-sm w-100 mb-2">
                    ê³¼ì œ ì¶”ê°€
                </a>

                <a href="/study/settings" class="btn btn-outline-secondary btn-sm w-100">
                    ìŠ¤í„°ë”” ì„¤ì •
                </a>
            </div>

            <!-- RECENT NOTICE -->
            <div class="bg-white p-4 rounded shadow-sm">
                <h6 class="fw-bold mb-3">ğŸ•’ ìµœê·¼ ê³µì§€</h6>

                <div th:if="${recentNotice == null || recentNotice.isEmpty()}" class="text-muted small">
                    ìµœê·¼ ê³µì§€ê°€ ì—†ìŠµë‹ˆë‹¤.
                </div>

                <div th:each="n : ${recentNotice}" class="mb-2">
                    <a th:href="@{/notice/{id}(id=${n.id})}" class="text-decoration-none">
                        <div class="border rounded p-2 small fw-semibold" th:text="${n.title}">
                            ìµœê·¼ ê³µì§€ ì œëª©
                        </div>
                    </a>
                </div>
            </div>

        </div>

    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    /* ìƒë‹¨ê³¼ ë™ì¼í•œ JS ì¸ì¦ ë¡œì§ */

    const isExist = (val) => val && val !== "null" && val !== "undefined" && val !== "";

    document.addEventListener("DOMContentLoaded", () => {

    const navArea = document.getElementById("navAuthArea");
        const token = localStorage.getItem("accessToken");
        const nickname = localStorage.getItem("nickname");
        const userId = localStorage.getItem("userId");
        if (isExist(token)) {
            const finalName = isExist(nickname) ? nickname : userId;
            navArea.innerHTML = `<span class="fw-bold me-2 text-dark">${finalName} ë‹˜</span><button class="btn btn-outline-danger btn-sm" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>`;
        } else {
            navArea.innerHTML = `<a href="/auth/signup" class="btn btn-primary btn-sm">íšŒì›ê°€ì…</a> <a href="/auth/login" class="btn btn-outline-primary btn-sm">ë¡œê·¸ì¸</a>`;
        }

    const form = document.getElementById("noticeForm");

    const studyIdEl = document.getElementById("studyId");
    const noticeIdEl = document.getElementById("noticeId");
    const modeEl = document.getElementById("mode");

    const editBtn = document.getElementById("editBtn");
    const deleteBtn = document.getElementById("deleteBtn");
    const cancelBtn = document.getElementById("cancelBtn");
    const saveBtn = document.getElementById("saveBtn");

    const studyId = studyIdEl?.value;
    const noticeId = noticeIdEl?.value;
    const mode = modeEl?.value || "view";

    if (mode === "view") {
        // localStorageì—ì„œ í˜„ì¬ ë¡œê·¸ì¸í•œ ìœ ì € IDë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
        const loginUserId = localStorage.getItem("userId");
        // íƒ€ì„ë¦¬í”„ë¥¼ í†µí•´ ì„œë²„ì—ì„œ ì „ë‹¬ë°›ì€ ì‘ì„±ì ID (HTML ë‚´ hidden í•„ë“œ ë“±ì— ì €ì¥ ê¶Œì¥)
        const authorId = "[[${notice != null ? notice.authorId : ''}]]";

        if (isExist(loginUserId) && String(loginUserId) === String(authorId)) {
            if(editBtn) editBtn.classList.remove("d-none");
            if(deleteBtn) deleteBtn.classList.remove("d-none");
        } else {
            // ë³¸ì¸ì´ ì•„ë‹ˆë©´ ìˆ¨ê¹€
            if(editBtn) editBtn.style.display = 'none';
            if(deleteBtn) deleteBtn.style.display = 'none';
        }
    }

    // 1) ìˆ˜ì • ë²„íŠ¼ í´ë¦­ ì‹œ: modeë¥¼ editìœ¼ë¡œ ë³€ê²½í•˜ì—¬ í˜ì´ì§€ ë¦¬ë¡œë“œ
    if (editBtn != null) {
        editBtn.addEventListener("click", () => {
            window.location.href = `/study/${studyId}/notice/${noticeId}?mode=edit`;
        });
    }

    // 2) ì‚­ì œ ë²„íŠ¼ í´ë¦­ ì‹œ: DELETE API í˜¸ì¶œ
    if (deleteBtn != null) {
        deleteBtn.addEventListener("click", async () => {
            if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

            const token = localStorage.getItem("accessToken");
            const auth = token?.startsWith("Bearer ") ? token : `Bearer ${token}`;

            const res = await fetch(`/api/study/${studyId}/notice/${noticeId}`, {
                method: "DELETE",
                headers: { "Authorization": auth }
            });

            if (res.ok) {
                alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                window.location.href = `/study/${studyId}`;
            } else {
                alert("ì‚­ì œ ì‹¤íŒ¨");
            }
        });
    }
    function logout() { if(confirm("ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { localStorage.clear(); window.location.href = "/"; } }

    form.addEventListener("submit", async (e) => {
            e.preventDefault();

            const token = localStorage.getItem("accessToken");
            if (!isExist(token)) {
                alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
                window.location.href = "/auth/login";
                return;
            }
            const auth = token.startsWith("Bearer ") ? token : `Bearer ${token}`;

            const title = form.querySelector('input[name="title"]').value.trim();
            const content = form.querySelector('textarea[name="content"]').value.trim();

            if (!title) return alert("ê³µì§€ ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            if (!content) return alert("ê³µì§€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");

            const payload = {
                title,
                content
            };

            let url, method;

            // âœ… Update
            if (isExist(noticeId)) {
                method = "PUT";
                url = `/api/study/${studyId}/notice/${noticeId}`;
            } else {
                // âœ… Create
                method = "POST";
                url = `/api/study/${studyId}/notice`;
            }

            const res = await fetch(url, {
                method,
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": auth
                },
                body: JSON.stringify(payload)
            });

            const text = await res.text().catch(() => "");
            if (!res.ok) {
                alert(`ì²˜ë¦¬ ì‹¤íŒ¨ (status=${res.status})\n${text}`);
                return;
            }

            // âœ… ì„±ê³µ â†’ ìŠ¤í„°ë”” ìƒì„¸ë¡œ ë³µê·€
            window.location.href = `/study/${studyId}`;
        });
  });

</script>
</body>
</html>